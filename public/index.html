<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Digital Skills Analytics</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* Dark Theme & Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #171821;
            color: #ffffff;
        }

        /* Card Styling */
        .card {
            background-color: #21222d;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chart-box {
            position: relative;
            width: 100%;
            height: 300px;
        }

        /* Neon Text Gradient */
        .text-neon {
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        /* Form Controls Dark Mode */
        select {
            background-color: #21222d;
            color: #fff;
            border: 1px solid #444;
            transition: all 0.2s;
        }

        select:hover {
            border-color: #00d2ff;
        }

        /* MathJax White Text Override */
        mjx-container {
            color: #a0aec0 !important;
            font-size: 90% !important;
        }

        /* Section Divider */
        .section-divider {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 4rem 0 2rem;
            position: relative;
        }

        .section-divider span {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #171821;
            padding: 0 1rem;
            color: #00d2ff;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
    </style>
</head>

<body class="antialiased selection:bg-cyan-500 selection:text-white">

    <!-- Navigation -->
    <nav class="bg-[#21222d] border-b border-gray-800 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl tracking-wide text-neon">
                ICT INTELLIGENCE
            </h1>

            <div class="flex items-center gap-2 bg-[#1b1c25] p-2 rounded-lg border border-gray-700">
                <span class="text-xs font-medium text-gray-400 uppercase tracking-wider px-2">Analysis Period</span>

                <div class="flex items-center gap-2">
                    <!-- Start Year Selector -->
                    <select id="startYear" onchange="loadDashboard()"
                        class="text-sm rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-cyan-500 cursor-pointer">
                        <option value="2021" selected>2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                    </select>

                    <span class="text-gray-500 text-xs">TO</span>

                    <!-- End Year Selector -->
                    <select id="endYear" onchange="loadDashboard()"
                        class="text-sm rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-cyan-500 cursor-pointer">
                        <option value="2022">2022</option>
                        <option value="2023" selected>2023</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8 max-w-7xl">

        <!-- Mock Data Warning -->
        <div id="mockNotice" class="hidden mb-6 text-center">
            <span
                class="inline-block px-4 py-1 rounded-full bg-cyan-900/30 text-cyan-400 text-xs font-medium border border-cyan-500/30">
                ⚠️ Preview Mode: Simulating live data connection
            </span>
        </div>

        <!-- Section 1: Growth & Gap Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">

            <!-- Gap Status Card -->
            <div class="card flex flex-col items-center justify-between col-span-1">
                <div class="w-full text-center">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Digital Gap Status</h3>
                    <div id="gapStatusText" class="text-3xl font-bold mt-1 tracking-tight">--</div>
                </div>

                <!-- Gap Metric Graph -->
                <div class="w-full h-32 mt-4">
                    <canvas id="gapBarChart"></canvas>
                </div>
            </div>

            <!-- Growth Cards -->
            <div class="card col-span-3 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <!-- Top Tier Growth -->
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Top Tier Growth (YoY)
                    </h3>
                    <div class="flex items-baseline gap-2">
                        <span id="topGrowth" class="text-5xl font-bold text-white">--%</span>
                        <span id="topGrowthLabel" class="text-sm font-medium text-gray-500">trend</span>
                    </div>
                </div>

                <!-- Bottom Tier Growth -->
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Bottom Tier Growth (YoY)
                    </h3>
                    <div class="flex items-baseline gap-2">
                        <span id="bottomGrowth" class="text-5xl font-bold text-white">--%</span>
                        <span id="bottomGrowthLabel" class="text-sm font-medium text-gray-500">trend</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Main Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <!-- Regional Maturity -->
            <div class="card lg:col-span-2">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-white">Regional Maturity Trends</h3>
                        <p class="text-xs text-gray-400">Aggregated performance by economic zone</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-cyan-500"></div><span
                                class="text-xs text-gray-400">Advanced</span>
                        </div>
                    </div>
                </div>
                <div class="chart-box">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>

            <!-- Top Creators -->
            <div class="card lg:col-span-1">
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-white">Top Creators</h3>
                    <p class="text-xs text-gray-400">Highest density of advanced skills (End Year)</p>
                </div>
                <div class="chart-box">
                    <canvas id="topChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Section 3: Trends & Ratio -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- NEW CHART: Multi-Year Trajectory (Replaces Correlation Scatter) -->
            <div class="card">
                <div class="mb-6 flex justify-between items-end">
                    <div>
                        <h3 class="text-lg font-bold text-white">Skill Evolution Trajectory</h3>
                        <p class="text-xs text-gray-400">Tracking top markets over selected period</p>
                    </div>
                    <div class="px-2 py-1 bg-gray-800 rounded text-[10px] text-cyan-400 border border-cyan-900">
                        MULTI-YEAR VIEW
                    </div>
                </div>
                <div class="chart-box">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3 class="text-lg font-bold text-white mb-6">Depth Ratio Ranking</h3>
                <div class="chart-box">
                    <canvas id="ratioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Footer Section: Project Context -->
        <div class="section-divider">
            <span>Project Intelligence</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            <div class="card lg:col-span-1 border-t-4 border-t-cyan-500">
                <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-2">Use Case</h3>
                <p class="text-sm text-gray-400 leading-relaxed mb-4">
                    This dashboard streamlines the pipeline from raw ITU data to actionable intelligence.
                    It specifically monitors <strong>Global Digital Literacy</strong> to identify workforce readiness
                    gaps across international markets.
                </p>
                <div class="text-xs text-gray-500">
                    <strong>Key Questions Answered:</strong>
                    <ul class="list-disc ml-4 mt-2 space-y-1 text-gray-400">
                        <li>Where are the advanced digital creators?</li>
                        <li>Is the digital divide widening?</li>
                        <li>Does basic literacy predict advanced skills?</li>
                    </ul>
                </div>
            </div>

            <div class="card lg:col-span-2">
                <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-4">KPI Equations & Logic</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div
                        class="bg-[#1b1c25] p-4 rounded border border-gray-700 hover:border-cyan-500/50 transition-colors">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Skill Depth Ratio</p>
                        <p class="text-sm text-gray-200 mb-1">$$ \frac{\text{Advanced \%}}{\text{Basic \%}} $$</p>
                        <p class="text-[10px] text-gray-500 mt-2">Measures quality over quantity.</p>
                    </div>
                    <div
                        class="bg-[#1b1c25] p-4 rounded border border-gray-700 hover:border-cyan-500/50 transition-colors">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">YoY Growth</p>
                        <p class="text-sm text-gray-200 mb-1">$$ \frac{Cur - Prev}{Prev} \times 100 $$</p>
                        <p class="text-[10px] text-gray-500 mt-2">Tracks acceleration of adoption.</p>
                    </div>
                    <div
                        class="bg-[#1b1c25] p-4 rounded border border-gray-700 hover:border-cyan-500/50 transition-colors">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Digital Divide</p>
                        <p class="text-sm text-gray-200 mb-1">$$ \Delta(\text{Top}, \text{Bottom}) $$</p>
                        <p class="text-[10px] text-gray-500 mt-2">Monitors global inequality trends.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic Script -->
    <script>
        let charts = {};

        // Mock Data Generator (Handles single year snapshots)
        function getMockData(year) {
            return {
                "top_advanced": [
                    { "country": "Korea, Rep.", "pct_above_basic": 79.3 }, { "country": "Malaysia", "pct_above_basic": 66.5 },
                    { "country": "Sweden", "pct_above_basic": 66.2 }, { "country": "Belgium", "pct_above_basic": 61.2 },
                    { "country": "Switzerland", "pct_above_basic": 57.3 }
                ],
                "digital_divide": {
                    "top_tier_avg_growth": 9.6,
                    "bottom_tier_avg_growth": -3.1
                },
                "depth_leaders": [
                    { "country": "Singapore", "skill_depth_ratio": 4.5 }, { "country": "Sweden", "skill_depth_ratio": 3.2 },
                    { "country": "Finland", "skill_depth_ratio": 2.8 }, { "country": "UK", "skill_depth_ratio": 2.5 },
                    { "country": "Germany", "skill_depth_ratio": 2.2 }
                ],
                "regional_index": [
                    { "country_name": "Euro Area", "pct_above_basic": 42 },
                    { "country_name": "OECD", "pct_above_basic": 44 },
                    { "country_name": "EU", "pct_above_basic": 40 },
                    { "country_name": "Arab States", "pct_above_basic": 25 },
                    { "country_name": "Americas", "pct_above_basic": 35 }
                ]
            };
        }

        async function loadDashboard() {
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);

            // Logic validation
            if (startYear > endYear) {
                alert("Start year must be before or equal to End year");
                return;
            }

            let data;
            try {
                const response = await fetch(`/api/dashboard-data?start_year=${startYear}&end_year=${endYear}`);
                if (!response.ok) throw new Error("Backend unavailable");
                data = await response.json();
                document.getElementById('mockNotice').classList.add('hidden');
            } catch (e) {
                console.warn("Using Mock Data");
                data = getMockData(endYear);
                // Mock trend data for fallback
                data.country_trends = {
                    'Korea, Rep.': [{ year: 2021, pct_above_basic: 70 }, { year: 2022, pct_above_basic: 75 }, { year: 2023, pct_above_basic: 80 }],
                    'Sweden': [{ year: 2021, pct_above_basic: 61 }, { year: 2022, pct_above_basic: 62 }, { year: 2023, pct_above_basic: 65 }],
                    'Malaysia': [{ year: 2021, pct_above_basic: 56 }, { year: 2022, pct_above_basic: 60 }, { year: 2023, pct_above_basic: 66 }]
                };
                document.getElementById('mockNotice').classList.remove('hidden');
            }

            // 2. Render Charts
            updateKPIs(data.digital_divide);
            renderSnapshotCharts(data);
            renderTrendChart(data.country_trends, startYear, endYear);
        }

        function updateKPIs(divideData) {
            if (!divideData) return;
            const top = divideData.top_tier_avg_growth || 0;
            const bottom = divideData.bottom_tier_avg_growth || 0;
            const gapIsWidening = top > bottom;

            // Helper to style positive/negative
            const styleMetric = (elementId, value) => {
                const el = document.getElementById(elementId);
                el.innerText = (value > 0 ? "+" : "") + value.toFixed(1) + "%";
                if (value >= 0) {
                    el.style.color = "#00d2ff"; // Cyan
                } else {
                    el.style.color = "#ff0055"; // Pink/Red
                }
            };

            styleMetric('topGrowth', top);
            styleMetric('bottomGrowth', bottom);

            // Render Gap Comparison Bar Chart
            const ctxGap = document.getElementById('gapBarChart').getContext('2d');
            createOrUpdateChart('gapBarChart', ctxGap, {
                type: 'bar',
                data: {
                    labels: ['Top Tier', 'Bottom Tier'],
                    datasets: [{
                        data: [top, bottom],
                        backgroundColor: [
                            top >= 0 ? '#00d2ff' : '#ff0055',
                            bottom >= 0 ? '#00d2ff' : '#ff0055'
                        ],
                        borderRadius: 4,
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            display: false, // Hide Y axis for cleaner look
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af', font: { size: 10 } }
                        }
                    }
                }
            });

            // Status Text Styling
            const statusText = document.getElementById('gapStatusText');
            statusText.innerText = gapIsWidening ? "WIDENING" : "CLOSING";
            statusText.style.color = gapIsWidening ? "#ff0055" : "#00d2ff"; // Pink for warning, Cyan for good

            // Add arrow indicator
            const arrow = gapIsWidening ? "↗" : "↘";
            statusText.innerText += " " + arrow;
        }

        function renderSnapshotCharts(data) {
            Chart.defaults.color = '#737691';
            Chart.defaults.font.family = "'Outfit', sans-serif";

            const darkOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#737691' } },
                    y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#737691' }, beginAtZero: true }
                }
            };

            const ctxRegion = document.getElementById('regionChart').getContext('2d');
            const gradientRegion = ctxRegion.createLinearGradient(0, 0, 0, 300);
            gradientRegion.addColorStop(0, 'rgba(0, 210, 255, 0.5)');
            gradientRegion.addColorStop(1, 'rgba(0, 210, 255, 0.0)');

            createOrUpdateChart('region', ctxRegion, {
                type: 'line',
                data: {
                    labels: data.regional_index ? data.regional_index.map(d => d.country_name) : [],
                    datasets: [{
                        label: 'Maturity',
                        data: data.regional_index ? data.regional_index.map(d => d.pct_above_basic) : [],
                        backgroundColor: gradientRegion,
                        borderColor: '#00d2ff',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#171821',
                        pointBorderColor: '#00d2ff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: darkOptions
            });

            // If regional_trends exists (from API), override the chart with multi-line
            if (data.regional_trends) {
                // Collect all unique years for labels
                const allYears = new Set();
                Object.values(data.regional_trends).forEach(points => points.forEach(p => allYears.add(p.year)));
                const labels = Array.from(allYears).sort();

                const colors = ['#00d2ff', '#7000ff', '#ff0055', '#10b981', '#f59e0b'];
                let colorIdx = 0;
                const datasets = [];

                for (const [region, points] of Object.entries(data.regional_trends)) {
                    const dataPoints = labels.map(year => {
                        const pt = points.find(p => p.year === year);
                        return pt ? pt.pct_above_basic : null;
                    });
                    datasets.push({
                        label: region,
                        data: dataPoints,
                        borderColor: colors[colorIdx % colors.length],
                        backgroundColor: colors[colorIdx % colors.length],
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        fill: false
                    });
                    colorIdx++;
                }

                createOrUpdateChart('region', ctxRegion, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        ...darkOptions,
                        plugins: { legend: { display: true, labels: { color: '#fff', font: { size: 10 } } } }
                    }
                });
            }

            const ctxTop = document.getElementById('topChart').getContext('2d');
            createOrUpdateChart('top', ctxTop, {
                type: 'bar',
                data: {
                    labels: data.top_advanced.map(d => d.country_name || d.country),
                    datasets: [{
                        data: data.top_advanced.map(d => d.pct_above_basic),
                        backgroundColor: (context) => context.dataIndex < 3 ? '#7000ff' : '#2d2e40',
                        borderRadius: 4,
                        barThickness: 8
                    }]
                },
                options: {
                    ...darkOptions,
                    indexAxis: 'y',
                    scales: {
                        x: { display: false },
                        y: { grid: { display: false }, ticks: { color: '#fff', font: { size: 11 } } }
                    }
                }
            });

            const ctxRatio = document.getElementById('ratioChart').getContext('2d');
            createOrUpdateChart('ratio', ctxRatio, {
                type: 'bar',
                data: {
                    labels: data.depth_leaders.map(d => d.country_name || d.country),
                    datasets: [{
                        data: data.depth_leaders.map(d => d.skill_depth_ratio),
                        backgroundColor: '#3a7bd5',
                        borderRadius: 4
                    }]
                },
                options: darkOptions
            });
        }

        function renderTrendChart(countryTrends, start, end) {
            if (!countryTrends) return;

            const years = [];
            for (let y = start; y <= end; y++) years.push(y);

            const colors = ['#00d2ff', '#a855f7', '#f43f5e', '#10b981', '#f59e0b'];
            let colorIdx = 0;
            const datasets = [];

            for (const [country, points] of Object.entries(countryTrends)) {
                // Align data to the year labels
                const dataPoints = years.map(year => {
                    const pt = points.find(p => p.year === year);
                    return pt ? pt.pct_above_basic : null;
                });

                datasets.push({
                    label: country,
                    data: dataPoints,
                    borderColor: colors[colorIdx % colors.length],
                    backgroundColor: colors[colorIdx % colors.length] + '1A', // 10% opacity
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#171821',
                    fill: false
                });
                colorIdx++;
            }

            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            createOrUpdateChart('trend', ctxTrend, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 10 } }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#737691' } },
                        y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#737691' } }
                    }
                }
            });
        }

        function createOrUpdateChart(key, ctx, config) {
            if (charts[key]) charts[key].destroy();
            charts[key] = new Chart(ctx, config);
        }

        loadDashboard();
    </script>
</body>

</html>